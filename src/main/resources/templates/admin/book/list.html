<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>List Book</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

</head>
<header th:insert="~{/admin/fragment/header.html::head}">

</header>
<body>
<div class="container">
    <div class="col-md-12">
        <div class="row">
            <form method="get" action="/admin/book/list">
                <div class="form-group">
                    <input type="text" class="form-control " placeholder="Author Name or Book Name" name="query"
                           th:value="${query}">
                </div>
            </form>
        </div>
    </div>
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-5">
                <span sec:authorize="hasRole('ADMIN')">
                    <button class="btn btn-success" onclick="window.location.href='/admin/book/edit'">Insert</button>
                    <button class="btn btn-danger" onclick="del()">Delete</button>
                </span>

            </div>
        </div>
    </div>
    <div class="col-md-12">
        <table class="table">
            <thead>
            <tr>
                <th class="center">
                    <label class="pos-rel">
                        <input type="checkbox" id="selectAll" class="ace"/>
                        <span class="lbl"></span>
                    </label>
                </th>
                <th>ID</th>
                <th>NAME</th>
                <th>PAGE COUNT</th>
                <th>POINT</th>
                <th>AUTHOR</th>
                <th>CATEGORIES</th>
                <th>ACTION</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item:${books}">
                <td class="center">
                    <label class="pos-rel">
                        <input type="checkbox" class="ace" name="checkBooks[]" th:value="${item.getId()}">
                        <span class="lbl"></span>
                    </label>
                </td>
                <td th:utext="${item.getId()}"></td>
                <td th:utext="${item.getName()}"></td>
                <td th:utext="${item.getPageCount()}"></td>
                <td th:utext="${item.getPoint()}"></td>
                <td th:utext="${item.getAuthor()}"></td>
                <td th:utext="${item.getCategories()}"></td>
                <td>
                    <!--                    <button th:value="${item.getId()}" onclick="del(value)">Del</button>-->
                    <button id="btnEdit" th:value="${item.getId()}" onclick="directEdit(value)">Edit</button>
                    <span sec:authorize="hasRole('ADMIN')">
                        <button id="btnModel" th:value="${item.getId()}" onclick="changeModal(value)"
                                data-toggle="modal"
                                data-target="#myModal">Assignment
                        </button>
                    </span>

                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- The Modal -->
    <div class="modal" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Assignment Book to Staff</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body" id="modalBody">
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="assignment">Assignment</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>
</div>
<script>
    function directEdit(value) {
        window.location.href = "/admin/book/edit?id=" + value
    }

    function del() {
        if (confirm("Do you want delete ??")) {
            let values = [];
            $.each($("input[name='checkBooks[]']:checked"), function () {
                values.push($(this).val());
            });
            console.log(values)
            $.ajax({
                url: "/api/book",
                method: "delete",
                data: JSON.stringify(values),
                contentType: "application/json",
                success: (res) => {
                    alert("Done !!!")
                    window.location.href = "/admin/book/list"
                },
                error: (res) => {
                    alert(res.responseJSON.message);
                }
            })
        }
    }

    $("#selectAll").click(function () {
        $("input[name='checkBooks[]']").prop('checked', $(this).prop('checked'));
    });

    let bookId = "";

    function changeModal(value) {
        bookId = value
        $("#modalBody").empty()
        $.ajax({
            url: "/api/book/" + value,
            method: "get",
            dataType: "json",
            success: (res) => {
                console.log(res)
                res.forEach(item => {
                    let ttd = '<label class="pos-rel">'
                        + '<input type="checkbox"' + item.checked + ' class="ace" name="checkStaffs[]" value="' + item.id + '">'
                        + '  <span class="lbl"></span>'
                        + '</label>'
                    let str = "<tr> <td class='center'>" + ttd + "</td> <td>" + item.fullName + "</td> </tr> "
                    $("#modalBody").append(str)
                })
            },
            error: (res) => {
                alert(res.responseJSON.message);
            }
        })
    }

    $("#assignment").click(e => {
        let values = [];
        $.each($("input[name='checkStaffs[]']:checked"), function () {
            values.push($(this).val());
        });
        console.log(values)
        $.ajax({
            url: "/api/book/assignment/" + bookId,
            method: "post",
            data: JSON.stringify(values),
            contentType: "application/json",
            success: () => {
                window.location.href = "/admin/book/list"
            },
            error: (res) => {
                alert(res.responseJSON.message);
            }
        })
    })
</script>
</body>
</html>